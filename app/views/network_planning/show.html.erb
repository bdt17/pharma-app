<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1><%= @plan.name %></h1>
      <p class="text-muted mb-0">
        <%= @plan.plan_start_date %> to <%= @plan.plan_end_date %> (<%= @plan.duration_days %> days)
      </p>
    </div>
    <div>
      <% if @plan.status == 'draft' || @plan.status == 'pending_approval' %>
        <%= button_to 'Approve', approve_network_planning_path(@plan), method: :post, class: 'btn btn-success me-2' %>
        <%= button_to 'Reject', reject_network_planning_path(@plan), method: :post, class: 'btn btn-danger' %>
      <% end %>
      <%= link_to 'Back to Plans', network_planning_index_path, class: 'btn btn-outline-secondary ms-2' %>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Status</h5>
          <span class="badge fs-5 <%= @plan.status == 'approved' ? 'bg-success' : (@plan.status == 'rejected' ? 'bg-danger' : 'bg-secondary') %>">
            <%= @plan.status.titleize %>
          </span>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Total Items</h5>
          <h2><%= @plan.capacity_plan_items.count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Capacity Gap</h5>
          <h2 class="<%= @plan.total_capacity_gap > 0 ? 'text-danger' : 'text-success' %>">
            <%= number_with_delimiter(@plan.total_capacity_gap) %>
          </h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Critical Items</h5>
          <h2 class="<%= @plan.critical_items.any? ? 'text-danger' : 'text-success' %>">
            <%= @plan.critical_items.count %>
          </h2>
        </div>
      </div>
    </div>
  </div>

  <% if @plan.recommendations_list.any? %>
    <div class="alert alert-info mb-4">
      <h5>Recommendations</h5>
      <ul class="mb-0">
        <% @plan.recommendations_list.each do |rec| %>
          <li><%= rec %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Lane Capacity Items</h5>
        </div>
        <div class="card-body">
          <% if @lane_items.any? %>
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Lane Code</th>
                  <th>Forecast Demand</th>
                  <th>Available Capacity</th>
                  <th>Gap</th>
                  <th>Utilization</th>
                  <th>Priority</th>
                  <th>Recommendation</th>
                </tr>
              </thead>
              <tbody>
                <% @lane_items.each do |item| %>
                  <tr class="<%= item.priority == 'critical' ? 'table-danger' : (item.priority == 'high' ? 'table-warning' : '') %>">
                    <td><%= item.lane_code %></td>
                    <td><%= number_with_delimiter(item.forecast_demand) %></td>
                    <td><%= number_with_delimiter(item.available_capacity) %></td>
                    <td class="<%= item.capacity_gap > 0 ? 'text-danger fw-bold' : '' %>">
                      <%= number_with_delimiter(item.capacity_gap) %>
                    </td>
                    <td>
                      <div class="progress" style="height: 20px;">
                        <div class="progress-bar <%= item.utilization_percent.to_f > 90 ? 'bg-danger' : (item.utilization_percent.to_f > 70 ? 'bg-warning' : 'bg-success') %>"
                             style="width: <%= [item.utilization_percent.to_f, 100].min %>%">
                          <%= item.utilization_percent %>%
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge <%= item.priority == 'critical' ? 'bg-danger' : (item.priority == 'high' ? 'bg-warning' : 'bg-secondary') %>">
                        <%= item.priority %>
                      </span>
                    </td>
                    <td><%= item.recommendation&.humanize %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted mb-0">No lane capacity items in this plan.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Node Capacity Items</h5>
        </div>
        <div class="card-body">
          <% if @node_items.any? %>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Forecast Demand</th>
                  <th>Available Capacity</th>
                  <th>Utilization</th>
                  <th>Priority</th>
                </tr>
              </thead>
              <tbody>
                <% @node_items.each do |item| %>
                  <tr>
                    <td><%= number_with_delimiter(item.forecast_demand) %></td>
                    <td><%= number_with_delimiter(item.available_capacity) %></td>
                    <td><%= item.utilization_percent %>%</td>
                    <td>
                      <span class="badge <%= item.priority == 'high' ? 'bg-warning' : 'bg-secondary' %>">
                        <%= item.priority %>
                      </span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted mb-0">No node capacity items in this plan.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Regional Items</h5>
        </div>
        <div class="card-body">
          <% if @region_items.any? %>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Region</th>
                  <th>Forecast Demand</th>
                </tr>
              </thead>
              <tbody>
                <% @region_items.each do |item| %>
                  <tr>
                    <td><%= item.region&.name || 'Unknown' %></td>
                    <td><%= number_with_delimiter(item.forecast_demand) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted mb-0">No regional items in this plan.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Plan Details</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-3">Created By</dt>
            <dd class="col-sm-9"><%= @plan.created_by || 'System' %></dd>

            <dt class="col-sm-3">Created At</dt>
            <dd class="col-sm-9"><%= @plan.created_at.strftime('%Y-%m-%d %H:%M:%S') %></dd>

            <% if @plan.approved_at %>
              <dt class="col-sm-3">Approved At</dt>
              <dd class="col-sm-9"><%= @plan.approved_at.strftime('%Y-%m-%d %H:%M:%S') %></dd>

              <dt class="col-sm-3">Approved By</dt>
              <dd class="col-sm-9"><%= @plan.approved_by %></dd>
            <% end %>

            <dt class="col-sm-3">Summary</dt>
            <dd class="col-sm-9"><%= @plan.summary || 'No summary available' %></dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>
